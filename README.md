## 2025-MIT6.824-lab3 Raft

- MIT6.824-2025分布式系统lab3实验记录 : 该实验在课程组所给出的框架下，初步实现了共识算法raft，包括领导人选举、日志追加、日志持久化、日志快照等功能，并提供了几个接口供上层应用可以使用该raft层实现简单的分布式应用
- Raft 专为管理日志复制，通过强 leader 架构、随机选举和模块化设计大幅提升可理解性与可实现性。其核心是将分布式一致性拆解为**leader 选举**、**日志复制**和**安全性保障**三大独立模块，并通过任期机制、有限状态和单向数据流简化逻辑，研究显示其学习难度显著低于 Paxos
- 理解 Raft 的核心在于把握“通过集中化（leader）降低协调成本，通过随机化（选举超时）简化冲突解决”的设计哲学。

#### 整体架构
![raft架构](/raft架构.jpg)

#### 核心架构与角色

**角色划分**：集群节点分为 leader（唯一写入口）、follower（被动同步）和 candidate（选举过渡态），正常状态仅有一个 leader

**任期机制（Term）**：时间被划分为连续任期（整数编号），每个任期始于选举，终于 leader 失效，任期号作为逻辑时钟防止过时消息干扰


**通信协议**：基于两种 RPC：RequestVote（选举投票）和 AppendEntries（日志复制+心跳），超时自动重试

#### 关键流程解析
**Leader 选举**
触发条件：follower 未在选举超时时间（150-300ms 随机值）内收到 leader 心跳，转为 candidate 并发起选举

- 投票规则：
1. candidate 自增任期号并向所有节点发送 RequestVote，携带自身最后日志条目的任期和索引

2. 节点在一个任期内仅投一票，且仅投票给日志“更新”的 candidate（比较最后日志的任期和长度）

- 冲突解决：**随机超时机制打散投票时机，避免选票分裂**；若 candidate 发现新 leader 或选举超时，自动退为 follower

**日志复制** (目前没研究到。。。)
写入流程：
leader 接收客户端命令，追加本地日志（含任期号和指令）。
通过 AppendEntries 并行复制至 followers，要求多数节点成功响应后提交日志，并通知 followers 应用至状态机

一致性保障：
日志匹配：AppendEntries 携带前一条日志的索引和任期，follower 验证匹配后才接受新条目，确保日志前缀一致

冲突修复：leader 维护每个 follower 的 nextIndex，不一致时递减重试，最终覆盖冲突日志

**安全性核心约束**
选举限制：新 leader 必须拥有所有已提交日志，通过投票阶段的日志新旧比较实现

提交规则：仅当前任期日志可直接提交（多数复制），旧任期日志需通过当前任期日志提交间接确认，防止已提交日志被覆盖

状态机安全：一旦某节点应用索引 N 的日志，其他节点在 N 位置必应用相同指令，由日志匹配和 leader 完整性保证

**工程扩展机制** （暂未研究。。。）
集群成员变更：采用联合共识（joint consensus），先同步新旧配置并存的过渡状态，确保两配置多数集重叠，避免双 leader 风险

日志压缩：通过快照（snapshot）保存系统状态，丢弃旧日志，快照包含最后日志索引、任期及配置信息，落后节点可通过 InstallSnapshot RPC 获取完整状态

可用性保障：满足 广播时间 << 选举超时 << 平均故障间隔，通常广播时间 0.5-20ms，选举超时 10-500ms，确保 leader 稳定
